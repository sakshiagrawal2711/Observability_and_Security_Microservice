<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Observability Dashboard</title>
  <style>
    :root{ --bg:#071029; --panel:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --accent-2:#7c3aed; --success:#10b981; --danger:#ef4444 }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0;background:linear-gradient(180deg,#051024,#082433);color:#e6eef9}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    header h1{font-size:1.4rem;margin:0}
    #user_info{font-size:0.95rem;color:var(--muted);display:flex;gap:8px;align-items:center}
    .token-pill{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:0.85rem;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:1000px){ .grid{grid-template-columns:360px 1fr} }
    .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
  .auth-box{background:transparent;padding:6px;border-radius:8px}
  .auth-box > div{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
  .auth-section{display:flex;flex-direction:column;gap:6px;padding:6px;flex:1;min-width:0}
  .auth-section input{width:100%;max-width:100%;box-sizing:border-box}
  .auth-divider{width:1px;background:rgba(255,255,255,0.03);margin:6px 0;align-self:stretch}
    .card h2{margin:0 0 8px 0;font-size:1rem;color:#e6eef9}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  label{font-size:0.9rem;color:var(--muted)}
  input[type="text"], input[type="password"], input[type="number"], input[type="datetime-local"]{padding:8px;border:1px solid rgba(255,255,255,0.04);border-radius:8px;background:transparent;color:#e6eef9;min-width:0}
  button{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(6,182,212,0.12)}
    button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .muted{color:var(--muted)}
    .kpi{display:flex;gap:10px}
    .kpi .tile{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;text-align:center}
    .kpi .num{font-size:1.2rem;font-weight:700}
    .small{font-size:0.85rem}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .alerts-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    .alert-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
    .badge{padding:6px 8px;border-radius:8px;font-weight:600}
    .badge.mem{background:rgba(124,58,237,0.12);color:#c7b3ff}
    .badge.cpu{background:rgba(6,182,212,0.08);color:#9ff1fb}
    table{width:100%;border-collapse:collapse;color:#e6eef9}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    th{font-size:0.85rem;color:var(--muted)}
    tr:nth-child(even) td{background:rgba(255,255,255,0.01)}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
  /* Ensure buttons in small rows (like thresholds) don't overflow and keep their intrinsic size */
  .card .row button{flex:0 0 auto}
    .center{display:flex;gap:8px}
    .toast{position:fixed;right:20px;bottom:20px;background:rgba(11,18,32,0.9);border:1px solid rgba(255,255,255,0.03);padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6);z-index:2000}
    .loader{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.4);z-index:1500}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Observability Dashboard</h1>
        <div class="muted small">System metrics, alerts, and thresholds — submission-ready</div>
      </div>
      <div id="user_info">
        Not logged in
      </div>
    </header>

    <div class="grid">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card">
          <h2>Account</h2>
          <div class="auth-box">
            <div style="display:flex;gap:8px">
              <div style="flex:1;min-width:0" class="auth-section">
                <div class="muted small">Register</div>
                <input id="reg_username" placeholder="new username" />
                <input id="reg_password" type="password" placeholder="new password" />
                <div style="display:flex;gap:8px">
                  <button id="btn_register" class="secondary">Create account</button>
                </div>
              </div>
              <div class="auth-divider" aria-hidden="true"></div>
              <div style="flex:1;min-width:0" class="auth-section">
                <div class="muted small">Login</div>
                <input id="ui_username" placeholder="username" />
                <input id="ui_password" type="password" placeholder="password" />
                <div style="display:flex;gap:8px">
                  <button id="btn_login">Login</button>
                  <button id="btn_logout" class="ghost">Logout</button>
                </div>
              </div>
            </div>
            <div id="auth_msg" class="small muted" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" id="summary_card">
          <h2>Summary</h2>
          <div class="row" style="gap:10px;margin-bottom:8px">
            <div style="flex:1;background:#fff;padding:10px;border-radius:8px;text-align:center">
              <div class="muted">Total Alerts</div>
              <div id="summary_total" style="font-weight:700;font-size:1.25rem">—</div>
            </div>
            <div style="flex:1;background:#fff;padding:10px;border-radius:8px;text-align:center">
              <div class="muted">Avg CPU (last 10)</div>
              <div id="summary_cpu" style="font-weight:700">—</div>
            </div>
            <div style="flex:1;background:#fff;padding:10px;border-radius:8px;text-align:center">
              <div class="muted">Avg Memory (last 10)</div>
              <div id="summary_mem" style="font-weight:700">—</div>
            </div>
          </div>
          <div style="margin-top:6px">
            <div class="muted small">Last alerts</div>
            <ul id="last_alerts" class="alerts-list" style="margin-top:6px"></ul>
          </div>
        </div>

        <div class="card">
          <h2>Thresholds</h2>
          <div class="row" style="margin-bottom:8px">
            <label class="small">CPU:</label>
            <input id="cpu" type="number" style="width:100px" />
            <label class="small">Memory:</label>
            <input id="mem" type="number" style="width:100px" />
            <button id="save">Save</button>
          </div>
          <div id="msg" class="small muted"></div>
        </div>
      </div>

      <div>
        <div class="card" id="chart-card">
          <h2>Charts</h2>
          <div class="controls" style="margin-bottom:8px">
            <label>Start: <input id="start" type="datetime-local" /></label>
            <label>End: <input id="end" type="datetime-local" /></label>
            <button id="load_history" class="secondary">Load History</button>
            <button id="clear_history" class="ghost">Clear</button>
          </div>
          <div id="chart-wrap"><canvas id="chart"></canvas></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Alerts (last 10)</h2>
          <div id="alerts_container">
            <ul id="alerts_list" class="alerts-list" style="margin-top:6px">Loading...</ul>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Metrics History</h2>
          <div class="toolbar" style="margin-bottom:8px;align-items:center;">
            <div class="center">
              <button id="export_csv" class="secondary">Export CSV</button>
            </div>
            <div class="muted small">Most recent metrics (click Export to download visible rows)</div>
          </div>
          <div style="max-height:260px;overflow:auto">
            <table id="metrics_table">
              <thead>
                <tr><th>Timestamp (IST)</th><th>CPU %</th><th>Memory %</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loader" class="loader" style="display:none"><div class="spinner" role="status" aria-label="Loading"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Persist token and username in localStorage; enhance UI updates
    let token = localStorage.getItem('token') || null;
    let username = localStorage.getItem('username') || null;
    function saveToken(t){ token = t; if(t) localStorage.setItem('token', t); else localStorage.removeItem('token'); }
    function saveUser(u){ username = u; if(u) localStorage.setItem('username', u); else localStorage.removeItem('username'); }
    function authHeaders(){ return token? {'token': token} : {} }

    function setUserInfo(){
      const el = document.getElementById('user_info');
      if(username){
        const tokenShort = token ? (token.slice(0,8) + '...' + token.slice(-6)) : '';
        el.innerHTML = `<span class="token-pill">User: ${username} <button id="copy_token" class="ghost" title="Copy token">Copy</button></span>`;
        const btn = document.getElementById('copy_token'); if(btn) btn.onclick = copyToken;
      } else {
        el.textContent = 'Not logged in';
      }
    }

    function copyToken(){
      if(!token){ showToast('No token to copy'); return; }
      navigator.clipboard.writeText(token).then(()=> showToast('Token copied to clipboard')).catch(()=> showToast('Copy failed'));
    }

    // Parse an ISO timestamp and return a Date object.
    // If the timestamp string does not include an explicit timezone, treat it as UTC by appending 'Z'.
    function parseISOtoDate(iso){
      if(!iso) return new Date();
      // already has timezone info (Z or +hh:mm or -hh:mm)
      if(/(Z|[+\-]\d{2}:?\d{2})$/.test(iso)) return new Date(iso);
      // otherwise assume the string is in UTC and append Z so JS parses it as UTC consistently
      // some servers return '2025-10-24T16:03:49.413448' (no timezone) — treat these as UTC
      return new Date(iso + 'Z');
    }

    // Format a timestamp in Indian Standard Time (IST)
    function formatIST(ts, opts){
      try{
        const d = (ts instanceof Date) ? ts : parseISOtoDate(ts);
        const o = Object.assign({}, opts || {});
        return d.toLocaleString('en-IN', Object.assign({timeZone:'Asia/Kolkata'}, o));
      }catch(e){ return (ts instanceof Date) ? ts.toLocaleString() : String(ts); }
    }

    function showToast(msg){
      const d = document.createElement('div'); d.className='toast'; d.textContent = msg; document.body.appendChild(d);
      setTimeout(()=>{ d.style.opacity='0'; setTimeout(()=>d.remove(),300) }, 3000);
    }

    function showLoader(){ document.getElementById('loader').style.display='flex'; }
    function hideLoader(){ document.getElementById('loader').style.display='none'; }

    async function getJson(path){
      const res = await fetch(path, {headers: authHeaders()});
      return res.json();
    }

    async function register(){
      const u = document.getElementById('reg_username').value;
      const p = document.getElementById('reg_password').value;
      if(!u || !p){ document.getElementById('auth_msg').textContent = 'Please provide username and password'; return; }
      const r = await fetch('/register', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
      const data = await r.json();
      if(r.status === 200){ document.getElementById('auth_msg').textContent = 'Account created — please login'; document.getElementById('reg_username').value=''; document.getElementById('reg_password').value=''; }
      else { document.getElementById('auth_msg').textContent = data.error || JSON.stringify(data); }
    }

    async function login(){
      const u = document.getElementById('ui_username').value;
      const p = document.getElementById('ui_password').value;
      const r = await fetch('/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
      const data = await r.json();
      if(r.status===200 && data.token){ saveToken(data.token); saveUser(u); document.getElementById('auth_msg').textContent = 'Logged in'; }
      else document.getElementById('auth_msg').textContent = JSON.stringify(data);
      setUserInfo();
      await refresh();
    }

    async function logout(){
      if(!token) { document.getElementById('auth_msg').textContent = 'Not logged in'; return; }
      const r = await fetch('/logout', {method:'POST', headers:{...authHeaders(), 'Content-Type':'application/json'}});
      if(r.status===200) { saveToken(null); saveUser(null); document.getElementById('auth_msg').textContent = 'Logged out'; setUserInfo(); await refresh(); }
      else { document.getElementById('auth_msg').textContent = 'Logout failed'; }
    }

    document.getElementById('btn_register').onclick = register;
    document.getElementById('btn_login').onclick = login;
    document.getElementById('btn_logout').onclick = logout;

    let chart = null;
    function createChart(){
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {label:'CPU %', data:[], borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.08)', fill:true, tension:0.2},
            {label:'Memory %', data:[], borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.08)', fill:true, tension:0.2}
          ]
        },
        options: {animation:false, responsive:true, maintainAspectRatio:false, scales:{y:{min:0,max:100}}}
      });
    }

    // load metrics either from live /metrics or /metrics/history when range provided
    async function loadMetrics(limit=20, start=null, end=null){
      if(start && end){
        const startIso = new Date(start).toISOString();
        const endIso = new Date(end).toISOString();
        return await getJson(`/metrics/history?start=${encodeURIComponent(startIso)}&end=${encodeURIComponent(endIso)}`);
      }
      return await getJson(`/metrics?limit=${limit}`);
    }

    async function refresh(){
      showLoader();
      try{
        setUserInfo();
        if(!token){
          // not logged in - clear summary and alerts area
          document.getElementById('summary_total').textContent = '—';
          document.getElementById('summary_cpu').textContent = '—';
          document.getElementById('summary_mem').textContent = '—';
          const alertsListEl = document.getElementById('alerts_list');
          const lastAlertsEl = document.getElementById('last_alerts');
          if(alertsListEl) alertsListEl.innerHTML = '<li class="small muted">Login to see alerts</li>';
          if(lastAlertsEl) lastAlertsEl.innerHTML = '<li class="small muted">Login to see recent alerts</li>';
          hideLoader();
          return;
        }

        const s = await getJson('/summary?n=10');
        if(s){
          document.getElementById('summary_total').textContent = s.total_alerts ?? '—';
          document.getElementById('summary_cpu').textContent = (s.avg_last_10_cpu!=null)? s.avg_last_10_cpu.toFixed(2) + ' %' : '—';
          document.getElementById('summary_mem').textContent = (s.avg_last_10_memory!=null)? s.avg_last_10_memory.toFixed(2) + ' %' : '—';
        }

        const mRes = await loadMetrics(20);
        const m = (mRes && mRes.value) ? mRes.value : (Array.isArray(mRes) ? mRes : (mRes || []));

        const alertsRes = await getJson('/alerts?limit=10');
        const alerts = alertsRes && alertsRes.value ? alertsRes.value : (Array.isArray(alertsRes) ? alertsRes : (alertsRes || []));

        const lastAlertsEl = document.getElementById('last_alerts');
        const alertsListEl = document.getElementById('alerts_list');
        if(lastAlertsEl) lastAlertsEl.innerHTML = '';
        if(alertsListEl) alertsListEl.innerHTML = '';
        if(alerts && alerts.length){
          alerts.forEach((a, idx)=>{
            const li = document.createElement('li');
            li.className = 'alert-item';
            const badge = document.createElement('span'); badge.className = 'badge ' + (a.type==='memory'?'mem':'cpu'); badge.textContent = a.type.toUpperCase();
            const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${formatIST(a.ts)}</div><div class="muted small">Value: ${a.value}</div>`;
            li.appendChild(left); li.appendChild(badge);
            if(alertsListEl) alertsListEl.appendChild(li.cloneNode(true));
            if(lastAlertsEl && idx < 5) lastAlertsEl.appendChild(li);
          });
        } else {
          if(alertsListEl) alertsListEl.innerHTML = '<li class="small muted">No alerts</li>';
          if(lastAlertsEl) lastAlertsEl.innerHTML = '<li class="small muted">No recent alerts</li>';
        }

        // update chart and metrics table
        const list = Array.isArray(m) ? m : (m.value || []);
        if(list && list.length){
          if(!chart) createChart();
          const labels = list.map(x=>formatIST(x.ts, {hour:'2-digit', minute:'2-digit', second:'2-digit'})).reverse();
          const cpuData = list.map(x=>x.cpu).reverse();
          const memData = list.map(x=>x.memory).reverse();
          chart.data.labels = labels;
          chart.data.datasets[0].data = cpuData;
          chart.data.datasets[1].data = memData;
          chart.update();
          // populate table
          const tbody = document.querySelector('#metrics_table tbody'); if(tbody){ tbody.innerHTML=''; list.slice().reverse().forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${formatIST(r.ts)}</td><td>${r.cpu}</td><td>${r.memory}</td>`; tbody.appendChild(tr); }); }
        }

        const t = await getJson('/thresholds');
        if(t){ document.getElementById('cpu').value = t.cpu_threshold; document.getElementById('mem').value = t.memory_threshold; }

        hideLoader();
      }catch(e){ console.error(e); hideLoader(); showToast('Error while refreshing data'); }
    }

    document.getElementById('save').onclick = async ()=>{
      const cpu = document.getElementById('cpu').value;
      const mem = document.getElementById('mem').value;
      const res = await fetch('/thresholds', {method:'POST', headers:{...authHeaders(),'Content-Type':'application/json'}, body:JSON.stringify({cpu_threshold:cpu, memory_threshold:mem})});
      const data = await res.json();
      if(res.status===200) document.getElementById('msg').textContent = 'Thresholds updated';
      else document.getElementById('msg').textContent = data.error || JSON.stringify(data);
      setTimeout(refresh, 500);
    }

    // history controls
    document.getElementById('load_history').onclick = async ()=>{
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      if(!start || !end){ alert('Please pick both start and end'); return; }
      const mRes = await loadMetrics(0, start, end);
      const list = (mRes && mRes.value) ? mRes.value : (Array.isArray(mRes) ? mRes : (mRes || []));
      if(!list || !list.length){ showToast('No metrics found in range'); return; }
      const labels = list.map(x=>formatIST(x.ts, {hour:'2-digit', minute:'2-digit', second:'2-digit'})).reverse();
      const cpuData = list.map(x=>x.cpu).reverse();
      const memData = list.map(x=>x.memory).reverse();
      if(!chart) createChart();
      chart.data.labels = labels;
      chart.data.datasets[0].data = cpuData;
      chart.data.datasets[1].data = memData;
      chart.update();
      // populate table
      const tbody = document.querySelector('#metrics_table tbody'); if(tbody){ tbody.innerHTML=''; list.slice().reverse().forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${formatIST(r.ts)}</td><td>${r.cpu}</td><td>${r.memory}</td>`; tbody.appendChild(tr); }); }
    };

    document.getElementById('clear_history').onclick = async ()=>{ document.getElementById('start').value=''; document.getElementById('end').value=''; await refresh(); };

    // Export currently-visible metrics table to CSV
    function tableToCSV(tableEl){
      const rows = Array.from(tableEl.querySelectorAll('tr'));
      return rows.map(r=>{
        const cols = Array.from(r.querySelectorAll('th,td')).map(c=>`"${String(c.textContent).replace(/"/g,'""')}"`);
        return cols.join(',');
      }).join('\n');
    }

    async function exportCSV(){
      const table = document.getElementById('metrics_table');
      if(!table){ showToast('No metrics table found'); return; }
      const csv = tableToCSV(table);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date();
      a.download = `metrics_${now.toISOString().replace(/[:.]/g,'-')}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('export_csv').onclick = exportCSV;

    // auto-refresh only when logged in and not viewing history
    setInterval(()=>{ if(token && !document.getElementById('start').value) refresh(); }, 5000);

    // initial load
    setUserInfo();
    if(token) document.getElementById('auth_msg').textContent = 'Using saved token';
    refresh();
  </script>
</body>
</html>